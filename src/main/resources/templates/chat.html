<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chat WhatsApp Style</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			background: #f0f2f5;
			font-family: sans-serif;
			margin: 20px;
		}

		.chat-container {
			width: 100%;
			max-width: 700px;
			margin: auto;
			background: white;
			border-radius: 10px;
			overflow: hidden;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		.chat-header {
			background: #007bff;
			color: white;
			padding: 15px;
			font-weight: bold;
			text-align: center;
		}

		.chat-body {
			height: 400px;
			overflow-y: auto;
			padding: 15px;
			background: #e5ddd5;
		}

		.message {
			padding: 10px 15px;
			margin: 5px 0;
			border-radius: 18px;
			max-width: 90%;
			word-wrap: break-word;
		}

		.sent {
			background: #dcf8c6;
			margin-left: auto;
			border-bottom-right-radius: 5px;
		}

		.received {
			background: white;
			margin-right: auto;
			border-bottom-left-radius: 5px;
		}

		.message-sender {
			font-weight: bold;
			font-size: 0.9em;
			margin-bottom: 3px;
			color: #555;
		}

		.message-time {
			font-size: 0.7em;
			color: #999;
			text-align: right;
		}

		.chat-footer {
			padding: 10px;
			background: #eee;
			display: flex;
			gap: 5px;
			flex-wrap: wrap;
		}

		#messageInput {
			flex: 1 1 auto;
			min-width: 70%;
		}

		/* Media queries pour mobile */
		@media (max-width: 480px) {
			.chat-header {
				font-size: 1.2em;
				padding: 10px;
			}

			.chat-body {
				height: 300px;
				padding: 10px;
			}

			.chat-footer {
				padding: 8px;
				gap: 3px;
			}

			#messageInput {
				font-size: 0.9em;
			}

			.btn {
				font-size: 0.9em;
				padding: 6px 10px;
			}
		}
	</style>
</head>

<body>
	<div class="chat-container">
		<div class="chat-header">ðŸ’¬ Chat de Groupe</div>
		<div class="chat-body" id="chatBody">
			<div class="message">Bienvenue dans le chat !</div>
		</div>
		<div class="chat-footer">
			<input type="text" id="messageInput" placeholder="Ã‰crire un message..." class="form-control">
			<button class="btn btn-primary" id="sendBtn">Envoyer</button>
		</div>
	</div>

	<!-- WebSocket -->
	<script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
	<script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const chatBody = document.getElementById("chatBody");
			const messageInput = document.getElementById("messageInput");
			const sendBtn = document.getElementById("sendBtn");

			// Pseudo automatique via localStorage ou prompt
			let pseudo = localStorage.getItem("pseudo");
			if (!pseudo) {
				pseudo = prompt("Entrez votre pseudo") || "Utilisateur";
				localStorage.setItem("pseudo", pseudo);
			}

			let stompClient = null;

			function connect() {
				const socket = new SockJS('/ws');
				stompClient = Stomp.over(socket);
				stompClient.debug = () => { };

				stompClient.connect({}, frame => {
					console.log('ConnectÃ© : ' + frame);
					stompClient.subscribe('/topic/messages', msg => {
						const message = JSON.parse(msg.body);
						showMessage(message);
					});
				}, error => {
					console.error('Erreur STOMP : ' + error);
				});
			}

			function showMessage(message) {
				const div = document.createElement("div");
				div.classList.add("message");

				const time = new Date(message.timestamp).toLocaleTimeString();

				if (message.sender === pseudo) {
					div.classList.add("sent");
					div.innerHTML = `<div class="message-content">${message.content}</div>
                             <div class="message-time">${time} (vous)</div>`;
				} else {
					div.classList.add("received");
					div.innerHTML = `<div class="message-sender">${message.sender}</div>
                             <div class="message-content">${message.content}</div>
                             <div class="message-time">${time}</div>`;
				}

				chatBody.appendChild(div);
				chatBody.scrollTo({top: chatBody.scrollHeight, behavior: 'smooth'});
			}

			function sendMessage() {
				const content = messageInput.value.trim();
				if (!content || !stompClient) return;

				stompClient.send("/app/chat.send", {}, JSON.stringify({
					sender: pseudo,
					content: content
				}));

				messageInput.value = '';
			}

			sendBtn.addEventListener("click", sendMessage);
			messageInput.addEventListener("keypress", e => {if (e.key === 'Enter') sendMessage();});

			connect();
		});
	</script>
</body>

</html>